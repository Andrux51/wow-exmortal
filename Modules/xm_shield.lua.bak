--XM object (REQUIRED)
XMSHIELD = LibStub("AceAddon-3.0"):NewAddon("XMSHIELD", "AceEvent-3.0", "AceConsole-3.0")

--embedded Libs
local XM_SMedia = LibStub("LibSharedMedia-3.0")

--local variables
local shieldspeed = 30
local shieldalpha = 0.8

--graphical tables
local shieldframe = {}

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:OnInitialize()
--called when addon loads

   --initalized shield frame
   XMSHIELD:AddShieldFrame()

   --register events
   XMSHIELD:RegisterEvent("PLAYER_REGEN_ENABLED")

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:ShieldStart()
--create a shield bar to scroll

    local i,j = 1,1
    while (i <= #shieldframe) do
        if (shieldframe[i].active == "false") then
            j = i
            i = #shieldframe + 1
        else
            j = j + 1
            i = i + 1
        end
    end

    if (j == #shieldframe + 1) then
        XMSHIELD:AddShieldFrame()
    end

    shieldframe[j].active = "grow"
    shieldframe[j].alpha = shieldalpha
    shieldframe[j]:SetPoint("BOTTOMRIGHT", UIParent, "CENTER", -300, -100)
    shieldframe[j]:SetHeight(0.01)

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:ShieldEnd()
--end the current shield bar

    local i = 1
    while (i <= #shieldframe) do
        if (shieldframe[i].active == "grow") then
            shieldframe[i].active = "move"
        end
    i = i + 1
    end

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:ShieldAnimate(offset)
--animate the shield bar, fade and remove as necessary

    local i = 1
    while (i <= #shieldframe) do
        if (shieldframe[i].alpha >= 0.01) then
            if (shieldframe[i].active == "grow") then
                --grow shield bar
                shieldframe[i]:SetHeight((shieldframe[i]:GetHeight()) + offset)
                if (shieldframe[i]:GetHeight() >= 400) then shieldframe[i]:SetHeight(400) end
            elseif (shieldframe[i]) then
                --move shield bar
                shieldframe[i].active = "move"
                local _,_,_,_,ypos = shieldframe[i]:GetPoint()
                if (ypos >= 400) then ypos = 400 end
                shieldframe[i]:SetPoint("BOTTOMRIGHT", UIParent, "CENTER", -300, (ypos + offset))
            
                if (ypos + offset >= 100) then
                    shieldframe[i].alpha = (shieldframe[i].alpha)*(1 - ((ypos + offset - 100)/(200))*0.02)
                end
            end    
            shieldframe[i].texture:SetVertexColor(0,0,1,shieldframe[i].alpha)        
        else
            shieldframe[i].active = "false"
        end
        i = i + 1
    end

end


--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:OnUpdate(elapsed)

    if (UnitIsGhost("player") == 1 or UnitIsDead("player") == 1) then
        xm_InCombat = false
    end
    XMSHIELD:ShieldAnimate((elapsed)*shieldspeed)

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:AddShieldFrame()

    local i = #shieldframe
    if (not i) then i = 0 end
    i = i + 1

    --main shield frame
    if (not shieldframe[i]) then
        shieldframe[i] = CreateFrame("Frame", "XM Shield Frame"..i, UIParent)
        shieldframe[i]:SetFrameStrata("HIGH")
        shieldframe[i]:SetPoint("BOTTOMRIGHT", UIParent, "CENTER", -300, -100)
        shieldframe[i]:SetHeight(0.01)
        shieldframe[i]:SetWidth(4)
        shieldframe[i]:SetScale(1)
        shieldframe[i]:SetAlpha(1)
        shieldframe[i]:SetScript("OnUpdate", function() XMSHIELD:OnUpdate(arg1) end)

        shieldframe[i].texture = shieldframe[i]:CreateTexture()
        shieldframe[i].texture:SetAllPoints(shieldframe[i])
        shieldframe[i].texture:SetTexture(XM_SMedia:Fetch("statusbar", "Smooth"))
        shieldframe[i].texture:SetVertexColor(0,0,1,0)
        shieldframe[i].alpha = 0
        shieldframe[i].active = "false"
        shieldframe[i]:Show()
    end

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMSHIELD:PLAYER_REGEN_ENABLED()
--player leaving combat

    XMSHIELD:ShieldEnd()

end