--XM object (REQUIRED)
XMINFO = LibStub("AceAddon-3.0"):NewAddon("XMINFO", "AceEvent-3.0", "AceConsole-3.0")

--embedded libs
local XM_SMedia = LibStub("LibSharedMedia-3.0")

--local variables
local infomove = false
local xm_GuildTime = 0
local xm_GuildName = ""
local xm_GuildCount = 0
local xm_GuildOnline = 0
local xm_FPSTime = 0
local xm_LagTime = 0
local xm_FriendTime = 0
local xm_FriendCount = 0
local xm_FriendOnline = 0

local infobuttons = {
    [1] = {"coord"},
    [2] = {"guild"},
    [3] = {"friend"},
    [4] = {"fps"},
    [5] = {"lag"},
    [6] = {"bag"},
    [7] = {"gold"},
    [8] = {"dur"},
    [9] = {"config"},
}

local movex = 0
local movey = 0

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:OnInitialize()
--called when addon loads

    --initialize info frame
    XMINFO:CreateInfoFrame()


    --register events
    XMINFO:RegisterEvent("ZONE_CHANGED")

    XMINFO:ZONE_CHANGED()

--    XMINFO:MoveMap()

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:ZONE_CHANGED()
--keep coords working properly

    if (WorldMapFrame:IsVisible() == 1) then
    else
        WorldMapFrame:Show()
        WorldMapFrame:Hide()
    end

end


--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:GUILD_ROSTER_UPDATE()

    XMINFO:GuildUpdate()
    if not(xm_GuildName == "") then
        infoframe_guildtext:SetText(xm_GuildName..": "..xm_GuildOnline)
        infoframe_friendtext:SetPoint("TOPLEFT", infoframe_guildtext, "TOPRIGHT", 10, 0)
    else
        infoframe_guildtext:SetText("")
        infoframe_friendtext:SetPoint("TOPLEFT", infoframe_guildtext, "TOPRIGHT", 0, 0)
    end

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:OnUpdate(elapsed)

    if (UnitIsGhost("player") == 1 or UnitIsDead("player") == 1) then
        XM.player.combatActive = false
    end

    local playerx,playery = GetPlayerMapPosition("player")
    local playerzone = GetZoneText()
    local playersubzone = GetSubZoneText()
    if (playersubzone == "") then
    else
        playersubzone = " : "..playersubzone
    end

    playerx = playerx * 100
    playery = playery * 100
    
    playerx = ("%.0f"):format(playerx)
    playery = ("%.0f"):format(playery)
    infoframe_coordtext:SetText("( "..playerx..","..playery.." ) "..playerzone..playersubzone)

    --update guild info every 30 seconds (blizzard limits calls to 10 second intervals)
    --GUILD_ROSTER_UPDATE only fires when you manually open the guild tab, not automatically with players logging in/out
    if ((GetTime() - xm_GuildTime) >= 30) then
        XMINFO:GuildUpdate()
        if not(xm_GuildName == "") then
            infoframe_guildtext:SetText(xm_GuildName..": "..xm_GuildOnline)
            infoframe_friendtext:SetPoint("TOPLEFT", infoframe_guildtext, "TOPRIGHT", 10, 0)
        else
            infoframe_guildtext:SetText("")
            infoframe_friendtext:SetPoint("TOPLEFT", infoframe_guildtext, "TOPRIGHT", 0, 0)
        end
    end

    --update friend info every 30 seconds
    if ((GetTime() - xm_FriendTime) >= 30) then
        XMINFO:FriendUpdate()
        infoframe_friendtext:SetText("Friends"..": "..xm_FriendOnline)
    end

    --performance data
    if ((GetTime() - xm_LagTime) >= 10) then    
        local _,_,latency = GetNetStats()
        latency = ("%.0f"):format(latency)
        infoframe_lagtext:SetText("Lag: "..latency)
        xm_LagTime = GetTime()
    end

    if ((GetTime() - xm_FPSTime) >= 10) then    
        local fps = GetFramerate()
        fps = ("%.0f"):format(fps)
        infoframe_fpstext:SetText("FPS: "..fps)
        xm_FPSTime = GetTime()
    end

    infoframe_bagtext:SetText("Bag: ")

    local totalcash = GetMoney()
    local gold = floor(totalcash / 10000)
    local silv = floor((totalcash - (gold * 10000)) / 100)
    if (silv < 10) and (gold > 0) then silv = "0"..silv end
    local copp = floor(totalcash - (gold * 10000) - (silv * 100))
    if (copp < 10) and (gold > 0 or silv > 0) then copp = "0"..copp end
    infoframe_goldtext:SetText(gold.."."..silv.."_"..copp)
    infoframe_durtext:SetText("Durability")

    infoframe_configtext:SetText("Config")

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:GuildUpdate()

    local name, rank, rankIndex, level, class, zone, note, officernote, online, status
    local guildname, guildrankname, guildrankindex

    xm_GuildTime = GetTime()
    guildname, guildrankname, guildrankindex = GetGuildInfo("player")
    xm_GuildName = ""
    xm_GuildCount = 0
    xm_GuildOnline = 0

    if (guildname) then
        xm_GuildName = guildname

        --call guildroster first to get accurate results
        GuildRoster()

        local i = 1
        while i >= 1 do
            name, rank, rankIndex, level, class, zone, note, officernote, online, status = GetGuildRosterInfo(i)
            if (name) then
                xm_GuildCount = xm_GuildCount + 1
                if (online) then
                    xm_GuildOnline = xm_GuildOnline + 1 
                end
                i = i + 1
            else
                xm_GuildCount = i - 1
                i = 0
            end
        end
    end
end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:FriendUpdate()

    local name, level, class, area, online, status, note

    xm_FriendTime = GetTime()
    xm_FriendCount = 0
    xm_FriendOnline = 0

    --call showfriends first to get accurate results
    ShowFriends()

    local i = 1
    while i >= 1 do
        name, level, class, area, online, status, note = GetFriendInfo(i)
        if (name) then
            xm_FriendCount = xm_FriendCount + 1
            if (online) then
               xm_FriendOnline = xm_FriendOnline + 1 
            end
            i = i + 1
        else
            xm_FriendCount = i - 1
            i = 0
        end
    end

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:CreateInfoFrame()

    --main info frame
    if (not XM_INFOFRAME) then
        XM_INFOFRAME = CreateFrame("Frame", "XM Info Frame", UIParent)
        XM_INFOFRAME:SetFrameStrata("HIGH")
        XM_INFOFRAME:SetPoint("TOPLEFT", UIParent)
        XM_INFOFRAME:SetPoint("TOPRIGHT", UIParent)
        XM_INFOFRAME:SetHeight(14)
        XM_INFOFRAME:SetScale(1)
        XM_INFOFRAME:SetAlpha(1)
        XM_INFOFRAME:SetScript("OnUpdate", function() XMINFO:OnUpdate(arg1) end)

        --movable info frame
        XM_INFOFRAME:SetMovable(true)
        XM_INFOFRAME:SetClampedToScreen(true)
        XM_INFOFRAME:EnableMouse(true)
        XM_INFOFRAME:SetScript("OnMouseDown", function() XMINFO:OnClick(arg1) end)
        XM_INFOFRAME:SetScript("OnMouseUp", function() XMINFO:OnDragStop(arg1) end)

        --info frame background
        XM_INFOBACK = CreateFrame("Frame", "XM Info Background", XM_INFOFRAME)
        XM_INFOBACK:SetAllPoints(XM_INFOFRAME)
        XM_INFOBACK.texture = XM_INFOBACK:CreateTexture()
        XM_INFOBACK.texture:SetAllPoints(XM_INFOBACK)
        XM_INFOBACK.texture:SetTexture(XM_SMedia:Fetch("statusbar", "Smooth"))
        XM_INFOBACK.texture:SetVertexColor(0,0,0,0.4)
    
        --coordframe background
        infoframe_coordback = CreateFrame("Frame", "infoframe_coordback", XM_INFOFRAME)
        infoframe_coordback:SetPoint("TOPRIGHT", XM_INFOFRAME, "BOTTOMRIGHT")
        infoframe_coordback:SetHeight(XM_INFOFRAME:GetHeight())
        infoframe_coordback:SetWidth(220)
        infoframe_coordback.texture = infoframe_coordback:CreateTexture()
        infoframe_coordback.texture:SetAllPoints(infoframe_coordback)
        infoframe_coordback.texture:SetTexture(XM_INFOBACK.texture:GetTexture())
        infoframe_coordback.texture:SetVertexColor(XM_INFOBACK.texture:GetVertexColor())

        --info frame foreground
        infoframe_infobar = CreateFrame("Frame", "infoframe_infobar", XM_INFOFRAME)
        infoframe_infobar:SetFrameLevel((XM_INFOFRAME:GetFrameLevel())+1)
        infoframe_infobar:SetAllPoints(XM_INFOFRAME)
        infoframe_infobar:SetHeight(XM_INFOFRAME:GetHeight())
        infoframe_infobar:SetWidth(XM_INFOFRAME:GetWidth())
    end

    local i = 1
    local infoframe_obj
    while (i <= #infobuttons) do
        infoframe_obj = "infoframe_"..infobuttons[i][1].."text"
        infoframe_obj = infoframe_infobar:CreateFontString(infoframe_obj, "OVERLAY", "GameFontNormal")
--        infoframe_obj:SetPoint(infobuttons[i][2])
        infoframe_obj:SetFont(XM_SMedia:Fetch("font","Emblem"), 10)
        infoframe_obj:SetTextColor(1,1,1,1)
--        infoframe_obj:SetAlpha(1)
        i = i + 1
    end

    infoframe_coordtext:SetPoint("TOPLEFT", infoframe_coordback, 2, -2)
    infoframe_guildtext:SetPoint("TOPLEFT", infoframe_infobar, 2, -2)
    infoframe_friendtext:SetPoint("TOPLEFT", infoframe_guildtext, "TOPRIGHT", 10, 0)
    infoframe_lagtext:SetPoint("TOPLEFT", infoframe_infobar, "TOPRIGHT", -50, -2)
    infoframe_fpstext:SetPoint("TOPRIGHT", infoframe_lagtext, "TOPLEFT", -8, 0)
    infoframe_bagtext:SetPoint("CENTER", infoframe_infobar)
    infoframe_goldtext:SetPoint("TOPLEFT", infoframe_bagtext, "TOPRIGHT", 20, 0)
    infoframe_durtext:SetPoint("TOPLEFT", infoframe_goldtext, "TOPRIGHT", 20, 0)
    infoframe_configtext:SetPoint("TOPLEFT", infoframe_durtext, "TOPRIGHT", 40, 0)

    infoframe_bagicon = CreateFrame("Frame", "infoframe_bagicon", XM_INFOFRAME)
    infoframe_bagicon:SetFrameLevel((XM_INFOFRAME:GetFrameLevel())+2)
    infoframe_bagicon:SetPoint("RIGHT", infoframe_bagtext, "LEFT")
    infoframe_bagicon:SetHeight(XM_INFOFRAME:GetHeight())
    infoframe_bagicon:SetWidth(1*(XM_INFOFRAME:GetHeight()))
    infoframe_bagicon.texture = infoframe_bagicon:CreateTexture()
    infoframe_bagicon.texture:SetAllPoints(infoframe_bagicon)
    infoframe_bagicon.texture:SetTexture("Interface\\Minimap\\Tracking\\Banker")
    infoframe_bagicon.texture:SetVertexColor(1,1,1,1)

    infoframe_goldicon = CreateFrame("Frame", "infoframe_goldicon", XM_INFOFRAME)
    infoframe_goldicon:SetFrameLevel((XM_INFOFRAME:GetFrameLevel())+2)
    infoframe_goldicon:SetPoint("RIGHT", infoframe_goldtext, "LEFT")
    infoframe_goldicon:SetHeight(XM_INFOFRAME:GetHeight())
    infoframe_goldicon:SetWidth(1*(XM_INFOFRAME:GetHeight()))
    infoframe_goldicon.texture = infoframe_goldicon:CreateTexture()
    infoframe_goldicon.texture:SetAllPoints(infoframe_goldicon)
    infoframe_goldicon.texture:SetTexture("Interface\\MoneyFrame\\UI-GoldIcon")
    infoframe_goldicon.texture:SetVertexColor(1,1,1,1)

    infoframe_duricon = CreateFrame("Frame", "infoframe_duricon", XM_INFOFRAME)
    infoframe_duricon:SetFrameLevel((XM_INFOFRAME:GetFrameLevel())+2)
    infoframe_duricon:SetPoint("RIGHT", infoframe_durtext, "LEFT")
    infoframe_duricon:SetHeight(XM_INFOFRAME:GetHeight())
    infoframe_duricon:SetWidth(1*(XM_INFOFRAME:GetHeight()))
    infoframe_duricon.texture = infoframe_duricon:CreateTexture()
    infoframe_duricon.texture:SetAllPoints(infoframe_duricon)
    infoframe_duricon.texture:SetTexture("Interface\\Minimap\\Tracking\\Repair")
    infoframe_duricon.texture:SetVertexColor(1,1,1,1)

    infoframe_configicon = CreateFrame("Frame", "infoframe_configicon", XM_INFOFRAME)
    infoframe_configicon:SetFrameLevel((XM_INFOFRAME:GetFrameLevel())+2)
    infoframe_configicon:SetPoint("RIGHT", infoframe_configtext, "LEFT")
    infoframe_configicon:SetHeight(XM_INFOFRAME:GetHeight())
    infoframe_configicon:SetWidth(1*(XM_INFOFRAME:GetHeight()))
    infoframe_configicon.texture = infoframe_configicon:CreateTexture()
    infoframe_configicon.texture:SetAllPoints(infoframe_configicon)
    infoframe_configicon.texture:SetTexture("Interface\\Cursor\\Interact")
    infoframe_configicon.texture:SetVertexColor(1,1,1,1)


    XM_INFOFRAME:Show()

end


--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:OnClick(inpbutton)

    if (inpbutton == "LeftButton" and IsControlKeyDown()) then
    elseif (inpbutton == "LeftButton" and IsShiftKeyDown()) then
        infomove = true
        movex, movey = GetCursorPosition()
        XM_INFOFRAME:StartMoving()
    end

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:OnDragStop()
--save position

    XMINFO:SavePosition()
    XM_INFOFRAME:StopMovingOrSizing()
    infomove = false

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:SavePosition()
--save position

    local cursorx, cursory = GetCursorPosition()
    movex = cursorx - movex
    movey = cursory - movey

end

--+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
function XMINFO:MoveMap()
--PlayerFrame
--PlayerFrame:SetPoint("TOPLEFT", XM_INFOFRAME, "BOTTOMLEFT", -34, 0)

--TargetFrame
--TargetFrame:SetPoint("TOPLEFT", XM_INFOFRAME, "BOTTOMLEFT", 240, 0)

--MinimapCluster
--TargetFrame:SetPoint("TOPRIGHT", XM_INFOFRAME, "BOTTOMRIGHT", 0, 0)

--PartyMemberFrame1
--TicketStatusFrame
--WorldStateAlwaysUpFrame
--MainMenuBar
--MultiBarRight
--CT_PlayerFrame_Drag
--CT_TargetFrame_Drag
--Gypsy_PlayerFrameCapsule
--Gypsy_TargetFrameCapsule
--TemporaryEnchantFrame
--DEFAULT_CHAT_FRAME
--ChatFrame2
--GroupLootFrame1
--TutorialFrameParent
--FramerateLabel
--QuestTimerFrame
--DurabilityFrame
--CastingBarFrame

end